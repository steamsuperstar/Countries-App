<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Equal Earth World Map (D3.js)</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      }

      body {
        margin: 0;
        padding: 24px;
        background: #f7f7fb;
        color: #1f2933;
      }

      h1 {
        margin-bottom: 0.5rem;
        font-size: clamp(1.5rem, 2vw + 1rem, 2.2rem);
      }

      p {
        max-width: 760px;
        line-height: 1.5;
      }

      .map-card {
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
        padding: 16px;
        margin-top: 20px;
      }

      svg {
        width: 100%;
        height: 520px;
        display: block;
      }

      .country {
        fill: #c9d6f2;
        stroke: #52637a;
        stroke-width: 0.4;
        cursor: pointer;
        transition: fill 150ms ease-in-out;
      }

      .country:hover {
        fill: #8fb0ff;
      }

      .country.is-selected {
        fill: #f97316;
      }

      .region {
        fill: #c9f0d3;
        stroke: #2f855a;
        stroke-width: 0.7;
        cursor: pointer;
        transition: fill 150ms ease-in-out;
      }

      .region:hover {
        fill: #8de1aa;
      }

      .region.is-selected {
        fill: #10b981;
      }

      .subregion {
        fill: #cde8f9;
        stroke: #285a84;
        stroke-width: 0.6;
        cursor: pointer;
        transition: fill 150ms ease-in-out;
      }

      .subregion:hover {
        fill: #7fc4f0;
      }

      .subregion.is-selected {
        fill: #0ea5e9;
      }

      .is-hidden {
        display: none;
      }

      .selected-label {
        font-weight: 600;
        margin-top: 12px;
        padding: 8px 12px;
        background: #eef2ff;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <h1>Equal Earth Projection: Interactive Countries Map</h1>
    <p>
      This beginner-friendly demo loads Natural Earth country boundaries using
      <strong>d3@7</strong> and <strong>topojson-client</strong>, then renders them with the
      <strong>Equal Earth</strong> projection. Click a country to highlight it and see its name.
    </p>
    <p>
      We also group the world into top-level <em>regions</em> (Africa, Americas, Asia, Europe,
      Oceania). Click a region to reveal its sub-regions, then click a sub-region to reveal its
      countries.
    </p>

    <div class="map-card">
      <svg id="world-map" viewBox="0 0 960 520" aria-label="World map"></svg>
      <div id="selected-country" class="selected-label">Selected: None</div>
    </div>

    <!--
      CSV lookup for ISO3166-1-numeric -> sub-region metadata.
      Keeping it inline ensures the demo works even when opened directly from disk.
    -->
    <script id="country-codes" type="text/csv">
numeric,region_code,region_name,subregion_code,subregion_name
8,150,Europe,039,Southern Europe
20,150,Europe,039,Southern Europe
70,150,Europe,039,Southern Europe
191,150,Europe,039,Southern Europe
292,150,Europe,039,Southern Europe
300,150,Europe,039,Southern Europe
336,150,Europe,039,Southern Europe
380,150,Europe,039,Southern Europe
470,150,Europe,039,Southern Europe
499,150,Europe,039,Southern Europe
620,150,Europe,039,Southern Europe
674,150,Europe,039,Southern Europe
688,150,Europe,039,Southern Europe
705,150,Europe,039,Southern Europe
724,150,Europe,039,Southern Europe
807,150,Europe,039,Southern Europe
100,150,Europe,151,Eastern Europe
112,150,Europe,151,Eastern Europe
203,150,Europe,151,Eastern Europe
348,150,Europe,151,Eastern Europe
498,150,Europe,151,Eastern Europe
616,150,Europe,151,Eastern Europe
642,150,Europe,151,Eastern Europe
643,150,Europe,151,Eastern Europe
703,150,Europe,151,Eastern Europe
804,150,Europe,151,Eastern Europe
208,150,Europe,154,Northern Europe
233,150,Europe,154,Northern Europe
234,150,Europe,154,Northern Europe
246,150,Europe,154,Northern Europe
248,150,Europe,154,Northern Europe
352,150,Europe,154,Northern Europe
372,150,Europe,154,Northern Europe
428,150,Europe,154,Northern Europe
440,150,Europe,154,Northern Europe
578,150,Europe,154,Northern Europe
744,150,Europe,154,Northern Europe
752,150,Europe,154,Northern Europe
826,150,Europe,154,Northern Europe
831,150,Europe,154,Northern Europe
832,150,Europe,154,Northern Europe
833,150,Europe,154,Northern Europe
40,150,Europe,155,Western Europe
56,150,Europe,155,Western Europe
250,150,Europe,155,Western Europe
276,150,Europe,155,Western Europe
438,150,Europe,155,Western Europe
442,150,Europe,155,Western Europe
492,150,Europe,155,Western Europe
528,150,Europe,155,Western Europe
756,150,Europe,155,Western Europe
    </script>

    <!-- D3 + TopoJSON libraries (CDN, no build tools required) -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script>
      // -----------------------------
      // 1) Basic SVG setup
      // -----------------------------
      const svg = d3.select("#world-map");
      const width = 960;
      const height = 520;

      // -----------------------------
      // 2) Projection + path generator
      // -----------------------------
      // Equal Earth is a good choice for thematic maps because it preserves
      // area well while keeping continents visually familiar.
      const projection = d3.geoEqualEarth().fitSize([width, height], { type: "Sphere" });
      const path = d3.geoPath(projection);

      // -----------------------------
      // 3) Data loading
      // -----------------------------
      // Natural Earth country geometries come from world-atlas (TopoJSON).
      const worldAtlasUrl =
        "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json";

      // Country code lookup table (CSV embedded in the HTML).
      const countryCodesCsv = d3.select("#country-codes").text().trim();

      function normalizeNumeric(value) {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? String(parsed) : String(value).trim();
      }

      const countryCodesUrl =
        "https://raw.githubusercontent.com/steamsuperstar/Countries-App/main/country-codes.csv";

      async function loadCountryCodes() {
        try {
          const response = await fetch(countryCodesUrl);
          if (response.ok) {
            return d3.csvParse(await response.text());
          }
        } catch (error) {
          // Ignore and attempt local fallback.
        }
        try {
          const response = await fetch("country-codes.csv");
          if (response.ok) {
            return d3.csvParse(await response.text());
          }
        } catch (error) {
          // If the file cannot be loaded (e.g., file:// protocol), fall back to inline CSV.
        }
        return d3.csvParse(countryCodesCsv);
      }

      Promise.all([d3.json(worldAtlasUrl), loadCountryCodes()]).then(
        ([topology, countryCodes]) => {
          // Convert TopoJSON to GeoJSON features so D3 can draw each country.
          const countries = topojson.feature(topology, topology.objects.countries).features;

          // Build a lookup for ISO numeric codes -> sub-region metadata.
          const subregionByNumeric = new Map(
            countryCodes.map((row) => [normalizeNumeric(row.numeric), row])
          );

          // Group the CSV by region/sub-region and build quick lookup helpers.
          const subregionGroups = d3.group(countryCodes, (row) => row.subregion_code);
          const regionGroups = d3.group(countryCodes, (row) => row.region_code);
          const allSubregionCodes = new Set(
            countryCodes.map((row) => normalizeNumeric(row.numeric))
          );

          const otherCountries = countries.filter(
            (feature) => !allSubregionCodes.has(normalizeNumeric(feature.id))
          );

          // Build sub-region metadata including merged geometry and member features.
          function safeMerge(geometries) {
            if (!geometries.length) {
              return null;
            }
            return topojson.merge(topology, geometries);
          }

          const subregions = Array.from(subregionGroups, ([code, rows]) => {
            const name = rows[0]?.subregion_name || "Sub-region";
            const regionCode = rows[0]?.region_code || "";
            const regionName = rows[0]?.region_name || "Region";
            const codes = new Set(rows.map((row) => normalizeNumeric(row.numeric)));
            const features = countries.filter((feature) =>
              codes.has(normalizeNumeric(feature.id))
            );
            const geometries = topology.objects.countries.geometries.filter((geometry) =>
              codes.has(normalizeNumeric(geometry.id))
            );

            return {
              code,
              name,
              regionCode,
              regionName,
              codes,
              features,
              geometry: safeMerge(geometries),
            };
          }).filter((subregion) => subregion.geometry && subregion.features.length > 0);

          // Build region metadata including merged geometry and related subregions.
          const regions = Array.from(regionGroups, ([code, rows]) => {
            const name = rows[0]?.region_name || "Region";
            const codes = new Set(rows.map((row) => normalizeNumeric(row.numeric)));
            const geometries = topology.objects.countries.geometries.filter((geometry) =>
              codes.has(normalizeNumeric(geometry.id))
            );
            const regionSubregions = subregions.filter(
              (subregion) => String(subregion.regionCode) === String(code)
            );

            return {
              code,
              name,
              codes,
              subregions: regionSubregions,
              geometry: safeMerge(geometries),
            };
          }).filter((region) => region.geometry && region.subregions.length > 0);

          // -----------------------------
          // 4) Draw layers
          // -----------------------------
          const countriesGroup = svg.append("g").attr("class", "countries-layer");
          const regionGroup = svg.append("g").attr("class", "regions-layer");
          const subregionGroup = svg
            .append("g")
            .attr("class", "subregions-layer is-hidden");
          const subregionCountriesGroup = svg
            .append("g")
            .attr("class", "subregion-countries-layer is-hidden");

          function drawCountries() {
            const baseCountries = regions.length ? otherCountries : countries;
            countriesGroup
              .selectAll("path")
              .data(baseCountries)
              .join("path")
              .attr("class", "country")
              .attr("d", path)
              .on("click", function (event, d) {
                clearSelections();
                d3.select(this).classed("is-selected", true);
                updateSelectionLabel(d.properties.name || "Unknown country");
              });
          }

          function drawRegions() {
            const hasRegions = regions.length > 0;
            regionGroup.classed("is-hidden", !hasRegions);

            regionGroup
              .selectAll("path")
              .data(regions)
              .join("path")
              .attr("class", "region")
              .attr("d", (d) => path(d.geometry))
              .on("click", function (event, d) {
                clearSelections();
                d3.select(this).classed("is-selected", true);
                drawSubregions(d);
                subregionGroup.classed("is-hidden", false);
                subregionGroup.raise();
                regionGroup.lower();
                subregionCountriesGroup.classed("is-hidden", true);
                updateSelectionLabel(`${d.name} (region)`);
              });
          }

          // Draw each sub-region for the selected region.
          function drawSubregions(region) {
            subregionGroup
              .selectAll("path")
              .data(region.subregions, (d) => d.code)
              .join("path")
              .attr("class", "subregion")
              .attr("d", (d) => path(d.geometry))
              .on("click", function (event, d) {
                clearSelections({ keepRegion: true, keepSubregions: true });
                d3.select(this).classed("is-selected", true);
                drawSubregionCountries(d);
                subregionCountriesGroup.classed("is-hidden", false);
                subregionCountriesGroup.raise();
                updateSelectionLabel(`${d.name} (sub-region)`);
              });
          }

          // Draw sub-region countries (hidden until a sub-region is selected).
          function drawSubregionCountries(subregion) {
            subregionCountriesGroup
              .selectAll("path")
              .data(subregion.features)
              .join("path")
              .attr("class", "country")
              .attr("d", path)
              .on("click", function (event, d) {
                // Keep the sub-region visible; only highlight the chosen country.
                subregionCountriesGroup.selectAll(".country").classed("is-selected", false);
                d3.select(this).classed("is-selected", true);
                const metadata = subregionByNumeric.get(normalizeNumeric(d.id));
                const subregionName = metadata?.subregion_name || subregion.name;
                updateSelectionLabel(`${d.properties.name || "Unknown"} (${subregionName})`);
              });
          }

          // -----------------------------
          // 5) Helper functions
          // -----------------------------
          function clearSelections(options = {}) {
            countriesGroup.selectAll(".country").classed("is-selected", false);
            if (!options.keepRegion) {
              regionGroup.selectAll(".region").classed("is-selected", false);
              subregionGroup.classed("is-hidden", true);
            }
            if (!options.keepSubregions) {
              subregionGroup.selectAll(".subregion").classed("is-selected", false);
              subregionGroup.classed("is-hidden", true);
            }
            subregionCountriesGroup.selectAll(".country").classed("is-selected", false);
            subregionCountriesGroup.classed("is-hidden", true);
          }

          function updateSelectionLabel(text) {
            d3.select("#selected-country").text(`Selected: ${text}`);
          }

          drawCountries();
          drawRegions();
        }
      );
    </script>
  </body>
</html>
