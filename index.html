<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Equal Earth World Map (D3.js)</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background: #f7f7fb;
        color: #1f2933;
      }

      h1 {
        margin-bottom: 0.5rem;
        font-size: clamp(1.5rem, 2vw + 1rem, 2.2rem);
      }

      p {
        max-width: 760px;
        line-height: 1.5;
      }

      .map-card {
        background: #ffffff;
        border-radius: 0;
        box-shadow: none;
        padding: 12px;
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .map-shell {
        position: relative;
        flex: 1 1 auto;
        min-height: 0;
      }

      svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .country {
        fill: #c9d6f2;
        stroke: #52637a;
        stroke-width: 0.4;
        cursor: pointer;
        transition: fill 150ms ease-in-out;
      }

      .country:hover {
        fill: #8fb0ff;
      }

      .country.is-selected {
        fill: #f97316;
      }

      .region {
        fill: #c9f0d3;
        stroke: #2f855a;
        stroke-width: 0.7;
        cursor: pointer;
        transition: fill 150ms ease-in-out;
      }

      .region:hover {
        fill: #8de1aa;
      }

      .region.is-selected {
        fill: #10b981;
      }

      .subregion {
        fill: #cde8f9;
        stroke: #285a84;
        stroke-width: 0.6;
        cursor: pointer;
        transition: fill 150ms ease-in-out;
      }

      .subregion:hover {
        fill: #7fc4f0;
      }

      .subregion.is-selected {
        fill: #0ea5e9;
      }

      .label {
        fill: #1d3557;
        text-anchor: middle;
        pointer-events: none;
      }

      .region-label {
        font-size: 16px;
        font-weight: 700;
      }

      .subregion-label {
        font-size: 13px;
        font-weight: 600;
      }

      .country-label {
        font-size: 3px;
        font-weight: 500;
      }

      .is-hidden {
        display: none;
      }

      .selected-label {
        font-weight: 600;
        margin: 0;
        padding: 8px 12px;
        background: #eef2ff;
        border-radius: 8px;
        position: absolute;
        left: 12px;
        bottom: 12px;
      }

      .facts-panel {
        padding: 20px 12px 32px;
        display: grid;
        gap: 12px;
      }

      .fact-card {
        background: #ffffff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
      }

      .fact-card h4 {
        margin: 0 0 8px;
        font-size: 1rem;
        color: #0f172a;
      }

      .fact-card p {
        margin: 0;
        font-size: 0.95rem;
        color: #334155;
      }

      .fact-card.is-hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="map-card">
      <div class="map-shell">
        <svg id="world-map" viewBox="0 0 960 520" aria-label="World map"></svg>
        <div id="selected-country" class="selected-label">Selected: None</div>
      </div>
      <section class="facts-panel" aria-label="UN M49 fun social facts">
        <article id="fact-card" class="fact-card is-hidden">
          <h4 id="fact-title"></h4>
          <p id="fact-body"></p>
        </article>
      </section>
    </div>

    <!--
      CSV lookup for ISO3166-1-numeric -> sub-region metadata.
      Keeping it inline ensures the demo works even when opened directly from disk.
    -->
    <script id="country-codes" type="text/csv">numeric,region_code,region_name,subregion_code,subregion_name
4,142,Asia,34,Southern Asia
248,150,Europe,154,Northern Europe
8,150,Europe,39,Southern Europe
12,2,Africa,15,Northern Africa
16,9,Oceania,61,Polynesia
20,150,Europe,39,Southern Europe
24,2,Africa,202,Sub-Saharan Africa
660,19,Americas,419,Latin America and the Caribbean
10,,,,
28,19,Americas,419,Latin America and the Caribbean
32,19,Americas,419,Latin America and the Caribbean
51,142,Asia,145,Western Asia
533,19,Americas,419,Latin America and the Caribbean
36,9,Oceania,53,Australia and New Zealand
40,150,Europe,155,Western Europe
31,142,Asia,145,Western Asia
44,19,Americas,419,Latin America and the Caribbean
48,142,Asia,145,Western Asia
50,142,Asia,34,Southern Asia
52,19,Americas,419,Latin America and the Caribbean
112,150,Europe,151,Eastern Europe
56,150,Europe,155,Western Europe
84,19,Americas,419,Latin America and the Caribbean
204,2,Africa,202,Sub-Saharan Africa
60,19,Americas,21,Northern America
64,142,Asia,34,Southern Asia
68,19,Americas,419,Latin America and the Caribbean
535,19,Americas,419,Latin America and the Caribbean
70,150,Europe,39,Southern Europe
72,2,Africa,202,Sub-Saharan Africa
74,19,Americas,419,Latin America and the Caribbean
76,19,Americas,419,Latin America and the Caribbean
86,2,Africa,202,Sub-Saharan Africa
92,19,Americas,419,Latin America and the Caribbean
96,142,Asia,35,South-eastern Asia
100,150,Europe,151,Eastern Europe
854,2,Africa,202,Sub-Saharan Africa
108,2,Africa,202,Sub-Saharan Africa
132,2,Africa,202,Sub-Saharan Africa
116,142,Asia,35,South-eastern Asia
120,2,Africa,202,Sub-Saharan Africa
124,19,Americas,21,Northern America
136,19,Americas,419,Latin America and the Caribbean
140,2,Africa,202,Sub-Saharan Africa
148,2,Africa,202,Sub-Saharan Africa
152,19,Americas,419,Latin America and the Caribbean
156,142,Asia,30,Eastern Asia
344,142,Asia,30,Eastern Asia
446,142,Asia,30,Eastern Asia
162,9,Oceania,53,Australia and New Zealand
166,9,Oceania,53,Australia and New Zealand
170,19,Americas,419,Latin America and the Caribbean
174,2,Africa,202,Sub-Saharan Africa
178,2,Africa,202,Sub-Saharan Africa
184,9,Oceania,61,Polynesia
188,19,Americas,419,Latin America and the Caribbean
191,150,Europe,39,Southern Europe
192,19,Americas,419,Latin America and the Caribbean
531,19,Americas,419,Latin America and the Caribbean
196,142,Asia,145,Western Asia
203,150,Europe,151,Eastern Europe
408,142,Asia,30,Eastern Asia
180,2,Africa,202,Sub-Saharan Africa
208,150,Europe,154,Northern Europe
262,2,Africa,202,Sub-Saharan Africa
212,19,Americas,419,Latin America and the Caribbean
214,19,Americas,419,Latin America and the Caribbean
218,19,Americas,419,Latin America and the Caribbean
818,2,Africa,15,Northern Africa
222,19,Americas,419,Latin America and the Caribbean
226,2,Africa,202,Sub-Saharan Africa
232,2,Africa,202,Sub-Saharan Africa
233,150,Europe,154,Northern Europe
748,2,Africa,202,Sub-Saharan Africa
231,2,Africa,202,Sub-Saharan Africa
238,19,Americas,419,Latin America and the Caribbean
234,150,Europe,154,Northern Europe
242,9,Oceania,54,Melanesia
246,150,Europe,154,Northern Europe
250,150,Europe,155,Western Europe
254,19,Americas,419,Latin America and the Caribbean
258,9,Oceania,61,Polynesia
260,2,Africa,202,Sub-Saharan Africa
266,2,Africa,202,Sub-Saharan Africa
270,2,Africa,202,Sub-Saharan Africa
268,142,Asia,145,Western Asia
276,150,Europe,155,Western Europe
288,2,Africa,202,Sub-Saharan Africa
292,150,Europe,39,Southern Europe
300,150,Europe,39,Southern Europe
304,19,Americas,21,Northern America
308,19,Americas,419,Latin America and the Caribbean
312,19,Americas,419,Latin America and the Caribbean
316,9,Oceania,57,Micronesia
320,19,Americas,419,Latin America and the Caribbean
831,150,Europe,154,Northern Europe
324,2,Africa,202,Sub-Saharan Africa
624,2,Africa,202,Sub-Saharan Africa
328,19,Americas,419,Latin America and the Caribbean
332,19,Americas,419,Latin America and the Caribbean
334,9,Oceania,53,Australia and New Zealand
336,150,Europe,39,Southern Europe
340,19,Americas,419,Latin America and the Caribbean
348,150,Europe,151,Eastern Europe
352,150,Europe,154,Northern Europe
356,142,Asia,34,Southern Asia
360,142,Asia,35,South-eastern Asia
364,142,Asia,34,Southern Asia
368,142,Asia,145,Western Asia
372,150,Europe,154,Northern Europe
833,150,Europe,154,Northern Europe
376,142,Asia,145,Western Asia
380,150,Europe,39,Southern Europe
384,2,Africa,202,Sub-Saharan Africa
388,19,Americas,419,Latin America and the Caribbean
392,142,Asia,30,Eastern Asia
832,150,Europe,154,Northern Europe
400,142,Asia,145,Western Asia
398,142,Asia,143,Central Asia
404,2,Africa,202,Sub-Saharan Africa
296,9,Oceania,57,Micronesia
414,142,Asia,145,Western Asia
417,142,Asia,143,Central Asia
418,142,Asia,35,South-eastern Asia
428,150,Europe,154,Northern Europe
422,142,Asia,145,Western Asia
426,2,Africa,202,Sub-Saharan Africa
430,2,Africa,202,Sub-Saharan Africa
434,2,Africa,15,Northern Africa
438,150,Europe,155,Western Europe
440,150,Europe,154,Northern Europe
442,150,Europe,155,Western Europe
450,2,Africa,202,Sub-Saharan Africa
454,2,Africa,202,Sub-Saharan Africa
458,142,Asia,35,South-eastern Asia
462,142,Asia,34,Southern Asia
466,2,Africa,202,Sub-Saharan Africa
470,150,Europe,39,Southern Europe
584,9,Oceania,57,Micronesia
474,19,Americas,419,Latin America and the Caribbean
478,2,Africa,202,Sub-Saharan Africa
480,2,Africa,202,Sub-Saharan Africa
175,2,Africa,202,Sub-Saharan Africa
484,19,Americas,419,Latin America and the Caribbean
583,9,Oceania,57,Micronesia
492,150,Europe,155,Western Europe
496,142,Asia,30,Eastern Asia
499,150,Europe,39,Southern Europe
500,19,Americas,419,Latin America and the Caribbean
504,2,Africa,15,Northern Africa
508,2,Africa,202,Sub-Saharan Africa
104,142,Asia,35,South-eastern Asia
516,2,Africa,202,Sub-Saharan Africa
520,9,Oceania,57,Micronesia
524,142,Asia,34,Southern Asia
528,150,Europe,155,Western Europe
540,9,Oceania,54,Melanesia
554,9,Oceania,53,Australia and New Zealand
558,19,Americas,419,Latin America and the Caribbean
562,2,Africa,202,Sub-Saharan Africa
566,2,Africa,202,Sub-Saharan Africa
570,9,Oceania,61,Polynesia
574,9,Oceania,53,Australia and New Zealand
580,9,Oceania,57,Micronesia
807,150,Europe,39,Southern Europe
578,150,Europe,154,Northern Europe
512,142,Asia,145,Western Asia
586,142,Asia,34,Southern Asia
585,9,Oceania,57,Micronesia
591,19,Americas,419,Latin America and the Caribbean
598,9,Oceania,54,Melanesia
600,19,Americas,419,Latin America and the Caribbean
604,19,Americas,419,Latin America and the Caribbean
608,142,Asia,35,South-eastern Asia
612,9,Oceania,61,Polynesia
616,150,Europe,151,Eastern Europe
620,150,Europe,39,Southern Europe
630,19,Americas,419,Latin America and the Caribbean
634,142,Asia,145,Western Asia
410,142,Asia,30,Eastern Asia
498,150,Europe,151,Eastern Europe
638,2,Africa,202,Sub-Saharan Africa
642,150,Europe,151,Eastern Europe
643,150,Europe,151,Eastern Europe
646,2,Africa,202,Sub-Saharan Africa
652,19,Americas,419,Latin America and the Caribbean
654,2,Africa,202,Sub-Saharan Africa
659,19,Americas,419,Latin America and the Caribbean
662,19,Americas,419,Latin America and the Caribbean
663,19,Americas,419,Latin America and the Caribbean
666,19,Americas,21,Northern America
670,19,Americas,419,Latin America and the Caribbean
882,9,Oceania,61,Polynesia
674,150,Europe,39,Southern Europe
678,2,Africa,202,Sub-Saharan Africa
682,142,Asia,145,Western Asia
686,2,Africa,202,Sub-Saharan Africa
688,150,Europe,39,Southern Europe
690,2,Africa,202,Sub-Saharan Africa
694,2,Africa,202,Sub-Saharan Africa
702,142,Asia,35,South-eastern Asia
534,19,Americas,419,Latin America and the Caribbean
703,150,Europe,151,Eastern Europe
705,150,Europe,39,Southern Europe
90,9,Oceania,54,Melanesia
706,2,Africa,202,Sub-Saharan Africa
710,2,Africa,202,Sub-Saharan Africa
239,19,Americas,419,Latin America and the Caribbean
728,2,Africa,202,Sub-Saharan Africa
724,150,Europe,39,Southern Europe
144,142,Asia,34,Southern Asia
275,142,Asia,145,Western Asia
729,2,Africa,15,Northern Africa
740,19,Americas,419,Latin America and the Caribbean
744,150,Europe,154,Northern Europe
752,150,Europe,154,Northern Europe
756,150,Europe,155,Western Europe
760,142,Asia,145,Western Asia
158,142,Asia,30,Eastern Asia
762,142,Asia,143,Central Asia
764,142,Asia,35,South-eastern Asia
626,142,Asia,35,South-eastern Asia
768,2,Africa,202,Sub-Saharan Africa
772,9,Oceania,61,Polynesia
776,9,Oceania,61,Polynesia
780,19,Americas,419,Latin America and the Caribbean
788,2,Africa,15,Northern Africa
792,142,Asia,145,Western Asia
795,142,Asia,143,Central Asia
796,19,Americas,419,Latin America and the Caribbean
798,9,Oceania,61,Polynesia
800,2,Africa,202,Sub-Saharan Africa
804,150,Europe,151,Eastern Europe
784,142,Asia,145,Western Asia
826,150,Europe,154,Northern Europe
834,2,Africa,202,Sub-Saharan Africa
581,9,Oceania,57,Micronesia
840,19,Americas,21,Northern America
850,19,Americas,419,Latin America and the Caribbean
858,19,Americas,419,Latin America and the Caribbean
860,142,Asia,143,Central Asia
548,9,Oceania,54,Melanesia
862,19,Americas,419,Latin America and the Caribbean
704,142,Asia,35,South-eastern Asia
876,9,Oceania,61,Polynesia
732,2,Africa,15,Northern Africa
887,142,Asia,145,Western Asia
894,2,Africa,202,Sub-Saharan Africa
716,2,Africa,202,Sub-Saharan Africa
    </script>

    <!-- D3 + TopoJSON libraries (CDN, no build tools required) -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script>
      // -----------------------------
      // 1) Basic SVG setup
      // -----------------------------
      const svg = d3.select("#world-map");
      const mapGroup = svg.append("g").attr("class", "map-root");
      const width = 960;
      const height = 520;

      // -----------------------------
      // 2) Projection + path generator
      // -----------------------------
      // Equal Earth is a good choice for thematic maps because it preserves
      // area well while keeping continents visually familiar.
      const projection = d3.geoEqualEarth().fitSize([width, height], { type: "Sphere" });
      const path = d3.geoPath(projection);

      // -----------------------------
      // 3) Data loading
      // -----------------------------
      // Natural Earth country geometries come from world-atlas (TopoJSON).
      const worldAtlasUrl =
        "https://cdn.jsdelivr.net/npm/visionscarto-world-atlas@1/world/50m.json";

      // Country code lookup table (CSV embedded in the HTML).
      const countryCodesCsv = d3.select("#country-codes").text().trim();

      function normalizeNumeric(value) {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? String(parsed) : String(value).trim();
      }

      const countryCodesUrl =
        "https://raw.githubusercontent.com/steamsuperstar/Countries-App/main/country-codes.csv";

      function normalizeCountryCodeRow(row) {
        if (row.region_code || row.subregion_code) {
          return row;
        }
        return {
          numeric: row["ISO3166-1-numeric"] ?? row.numeric,
          region_code: row["Region Code"] ?? row.region_code,
          region_name: row["Region Name"] ?? row.region_name,
          subregion_code: row["Sub-region Code"] ?? row.subregion_code,
          subregion_name: row["Sub-region Name"] ?? row.subregion_name,
        };
      }

      function normalizeCountryCodes(rows) {
        return rows.map(normalizeCountryCodeRow);
      }

      async function loadCountryCodes() {
        try {
          const response = await fetch(countryCodesUrl);
          if (response.ok) {
            return normalizeCountryCodes(d3.csvParse(await response.text()));
          }
        } catch (error) {
          // Ignore and attempt local fallback.
        }
        try {
          const response = await fetch("country-codes.csv");
          if (response.ok) {
            return normalizeCountryCodes(d3.csvParse(await response.text()));
          }
        } catch (error) {
          // If the file cannot be loaded (e.g., file:// protocol), fall back to inline CSV.
        }
        return normalizeCountryCodes(d3.csvParse(countryCodesCsv));
      }

      Promise.all([d3.json(worldAtlasUrl), loadCountryCodes()]).then(
        ([topology, countryCodes]) => {
          // Convert TopoJSON to GeoJSON features so D3 can draw each country.
          const countryObjectKey =
            ["countries", "world", "admin", "ne_50m_admin_0_countries"].find(
              (key) => topology.objects[key]
            ) ?? Object.keys(topology.objects)[0];
          const countryObject = topology.objects[countryObjectKey];
          const countries = topojson.feature(topology, countryObject).features;

          // Build a lookup for ISO numeric codes -> sub-region metadata.
          const validRows = countryCodes.filter(
            (row) => row.region_code && row.subregion_code
          );

          const subregionByNumeric = new Map(
            validRows.map((row) => [normalizeNumeric(row.numeric), row])
          );

          // Group the CSV by region/sub-region and build quick lookup helpers.
          const subregionGroups = d3.group(validRows, (row) => row.subregion_code);
          const regionGroups = d3.group(validRows, (row) => row.region_code);
          const allSubregionCodes = new Set(
            validRows.map((row) => normalizeNumeric(row.numeric))
          );

          const otherCountries = countries.filter(
            (feature) => !allSubregionCodes.has(normalizeNumeric(feature.id))
          );

          // Build sub-region metadata including merged geometry and member features.
          function safeMerge(geometries) {
            if (!geometries.length) {
              return null;
            }
            return topojson.merge(topology, geometries);
          }

          const subregions = Array.from(subregionGroups, ([code, rows]) => {
            const name = rows[0]?.subregion_name || "Sub-region";
            const regionCode = rows[0]?.region_code || "";
            const regionName = rows[0]?.region_name || "Region";
            const codes = new Set(rows.map((row) => normalizeNumeric(row.numeric)));
            const features = countries.filter((feature) =>
              codes.has(normalizeNumeric(feature.id))
            );
            const geometries = countryObject.geometries.filter((geometry) =>
              codes.has(normalizeNumeric(geometry.id))
            );

            return {
              code,
              name,
              regionCode,
              regionName,
              codes,
              features,
              geometry: safeMerge(geometries),
            };
          }).filter((subregion) => subregion.geometry && subregion.features.length > 0);

          // Build region metadata including merged geometry and related subregions.
          const regions = Array.from(regionGroups, ([code, rows]) => {
            const name = rows[0]?.region_name || "Region";
            const codes = new Set(rows.map((row) => normalizeNumeric(row.numeric)));
            const geometries = countryObject.geometries.filter((geometry) =>
              codes.has(normalizeNumeric(geometry.id))
            );
            const regionSubregions = subregions.filter(
              (subregion) => String(subregion.regionCode) === String(code)
            );

            return {
              code,
              name,
              codes,
              subregions: regionSubregions,
              geometry: safeMerge(geometries),
            };
          }).filter((region) => region.geometry && region.subregions.length > 0);

          const regionFacts = new Map([
            [
              "Africa",
              {
                code: "002",
                fact:
                  "Africa is home to the youngest population in the world — more than 60% of Africans are under 25, shaping global music, fashion, and digital culture.",
              },
            ],
            [
              "Americas",
              {
                code: "019",
                fact:
                  "The Americas contain every major world religion, yet many of the region’s most influential cultural movements (jazz, hip-hop, salsa) originated locally.",
              },
            ],
            [
              "Asia",
              {
                code: "142",
                fact:
                  "Asia contains more languages than any other region, with over 2,300 living languages spoken across the continent.",
              },
            ],
            [
              "Europe",
              {
                code: "150",
                fact:
                  "Europe has the highest number of international borders per square kilometer, which helps explain its dense mix of languages, cuisines, and identities.",
              },
            ],
            [
              "Oceania",
              {
                code: "009",
                fact:
                  "Oceania’s societies are among the most maritime-oriented cultures on Earth, with navigation traditions that predate modern instruments.",
              },
            ],
            [
              "Antarctica",
              {
                code: "010",
                fact:
                  "Antarctica has no permanent population, yet is governed cooperatively by dozens of countries under international treaties — a rare example of peaceful global governance.",
              },
            ],
          ]);

          const subregionFacts = new Map([
            [
              "Northern Africa",
              {
                code: "015",
                fact:
                  "Arabic, Amazigh (Berber), French, and English influences intersect here, making it one of the world’s most linguistically blended regions.",
              },
            ],
            [
              "Western Africa",
              {
                code: "011",
                fact:
                  "Western Africa is a global music powerhouse, influencing jazz, blues, reggae, and Afrobeat worldwide.",
              },
            ],
            [
              "Middle Africa",
              {
                code: "017",
                fact:
                  "Extended family networks play a central social role, often functioning as economic safety nets where formal systems are limited.",
              },
            ],
            [
              "Eastern Africa",
              {
                code: "014",
                fact:
                  "This region is considered a cradle of humanity and remains one of the world’s most linguistically diverse areas.",
              },
            ],
            [
              "Southern Africa",
              {
                code: "018",
                fact:
                  "Southern Africa has some of the strongest traditions of oral storytelling, where history is preserved through spoken narrative.",
              },
            ],
            [
              "Northern America",
              {
                code: "021",
                fact:
                  "High levels of immigration have made Northern America one of the most culturally plural regions in the world.",
              },
            ],
            [
              "Central America",
              {
                code: "013",
                fact:
                  "Community festivals blending Indigenous, African, and European traditions are central to social life.",
              },
            ],
            [
              "Caribbean",
              {
                code: "029",
                fact:
                  "Despite its small land area, the Caribbean has had an outsized influence on global music, food, and sports.",
              },
            ],
            [
              "South America",
              {
                code: "005",
                fact:
                  "South America hosts some of the world’s strongest regional identities, where local culture often matters more than national borders.",
              },
            ],
            [
              "Central Asia",
              {
                code: "143",
                fact:
                  "Hospitality is a deeply rooted social value — guests are traditionally treated as honored visitors, regardless of social status.",
              },
            ],
            [
              "Eastern Asia",
              {
                code: "030",
                fact:
                  "Collective harmony and respect for elders are core social values that strongly influence education and work culture.",
              },
            ],
            [
              "Southern Asia",
              {
                code: "034",
                fact:
                  "This sub-region has some of the largest and most vibrant family networks in the world, often spanning multiple generations under one roof.",
              },
            ],
            [
              "South-eastern Asia",
              {
                code: "035",
                fact:
                  "Markets and street food are central social spaces, acting as daily meeting points for communities.",
              },
            ],
            [
              "Western Asia",
              {
                code: "145",
                fact:
                  "Family, tribe, and community affiliations often shape social identity as strongly as nationality.",
              },
            ],
            [
              "Northern Europe",
              {
                code: "154",
                fact:
                  "High trust in public institutions supports strong social welfare systems and high levels of civic participation.",
              },
            ],
            [
              "Western Europe",
              {
                code: "155",
                fact:
                  "Many modern ideas about democracy, labor rights, and social contracts emerged here and spread globally.",
              },
            ],
            [
              "Southern Europe",
              {
                code: "039",
                fact:
                  "Daily social life is highly public — cafés, plazas, and streets are important community spaces.",
              },
            ],
            [
              "Eastern Europe",
              {
                code: "151",
                fact:
                  "Shared historical experiences have fostered strong traditions of resilience, mutual aid, and cultural preservation.",
              },
            ],
            [
              "Australia and New Zealand",
              {
                code: "053",
                fact:
                  "Indigenous cultures emphasize a deep spiritual connection to land, influencing modern conversations about identity and stewardship.",
              },
            ],
            [
              "Melanesia",
              {
                code: "054",
                fact:
                  "Village-based social organization remains central, with strong obligations to kin and community.",
              },
            ],
            [
              "Micronesia",
              {
                code: "057",
                fact:
                  "Social status is often linked to knowledge of genealogy and navigation rather than wealth.",
              },
            ],
            [
              "Polynesia",
              {
                code: "061",
                fact:
                  "Culture is preserved through performance — dance, chant, and ceremony are essential to social continuity.",
              },
            ],
          ]);

          // -----------------------------
          // 4) Draw layers
          // -----------------------------
          const countriesGroup = mapGroup.append("g").attr("class", "countries-layer");
          const regionGroup = mapGroup.append("g").attr("class", "regions-layer");
          const subregionGroup = mapGroup
            .append("g")
            .attr("class", "subregions-layer is-hidden");
          const subregionCountriesGroup = mapGroup
            .append("g")
            .attr("class", "subregion-countries-layer is-hidden");
          const regionLabelsGroup = mapGroup
            .append("g")
            .attr("class", "region-labels-layer");
          const subregionLabelsGroup = mapGroup
            .append("g")
            .attr("class", "subregion-labels-layer is-hidden");
          const countryLabelsGroup = mapGroup
            .append("g")
            .attr("class", "country-labels-layer is-hidden");
          const zoom = d3
            .zoom()
            .scaleExtent([1, 8])
            .on("zoom", (event) => {
              mapGroup.attr("transform", event.transform);
            });

          svg.call(zoom);
          svg.on("click", (event) => {
            if (event.defaultPrevented) return;
            const target = event.target;
            const isShapeClick =
              target.closest(".region") ||
              target.closest(".subregion") ||
              target.closest(".country");
            if (!isShapeClick) {
              clearSelections();
              updateSelectionLabel("None");
              updateFactPanel(null);
            }
          });

          function zoomToGeometry(geometry, options = {}) {
            const [[x0, y0], [x1, y1]] = path.bounds(geometry);
            const dx = x1 - x0;
            const dy = y1 - y0;
            const fallbackCenter = [(x0 + x1) / 2, (y0 + y1) / 2];
            const [x, y] = options.center ?? fallbackCenter;
            const padding = options.padding ?? 0.9;
            const maxScale = options.maxScale ?? 8;
            const scale = Math.min(maxScale, padding / Math.max(dx / width, dy / height));
            const xOffset = options.xOffset ?? 0;
            const yOffset = options.yOffset ?? 0;
            const translate = [
              width / 2 - scale * x + xOffset,
              height / 2 - scale * y + yOffset,
            ];
            svg
              .transition()
              .duration(options.duration ?? 450)
              .call(
                zoom.transform,
                d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
              );
          }

          function resetZoom() {
            svg.transition().duration(450).call(zoom.transform, d3.zoomIdentity);
          }

          function drawCountries() {
            const baseCountries = otherCountries.length ? otherCountries : countries;
            countriesGroup
              .selectAll("path")
              .data(baseCountries)
              .join("path")
              .attr("class", "country")
              .attr("d", path)
              .on("click", function (event, d) {
                clearSelections();
                d3.select(this).classed("is-selected", true);
                updateSelectionLabel(d.properties.name || "Unknown country");
              });
          }

          function drawRegions() {
            const hasRegions = regions.length > 0;
            regionGroup.classed("is-hidden", !hasRegions);
            if (hasRegions) {
              regionGroup.raise();
              countriesGroup.lower();
              countriesGroup.classed("is-hidden", true);
              regionLabelsGroup.raise();
            } else {
              countriesGroup.classed("is-hidden", false);
            }

            regionGroup
              .selectAll("path")
              .data(regions)
              .join("path")
              .attr("class", "region")
              .attr("d", (d) => path(d.geometry))
              .on("click", function (event, d) {
                event.stopPropagation();
                clearSelections();
                d3.select(this).classed("is-selected", true);
                drawSubregions(d);
                subregionGroup.classed("is-hidden", false);
                subregionGroup.raise();
                regionGroup.lower();
                subregionCountriesGroup.classed("is-hidden", true);
                regionLabelsGroup.classed("is-hidden", true);
                subregionLabelsGroup.classed("is-hidden", false);
                countryLabelsGroup.classed("is-hidden", true);
                subregionLabelsGroup.raise();
                if (d.name !== "Oceania") {
                  const useEuropeZoom = d.name === "Europe";
                  zoomToGeometry(d.geometry, {
                    duration: 450,
                    padding: useEuropeZoom ? 1.15 : 0.9,
                    maxScale: useEuropeZoom ? 9 : 8,
                  });
                }
                updateSelectionLabel(`${d.name} (region)`);
                updateFactPanel({ name: d.name, kind: "region" });
              });

            regionLabelsGroup
              .classed("is-hidden", !hasRegions)
              .selectAll("text")
              .data(regions, (d) => d.code)
              .join("text")
              .attr("class", "label region-label")
              .attr("x", (d) => path.centroid(d.geometry)[0])
              .attr("y", (d) => path.centroid(d.geometry)[1])
              .text((d) => d.name);
          }

          // Draw each sub-region for the selected region.
          function drawSubregions(region) {
            subregionGroup
              .selectAll("path")
              .data(region.subregions, (d) => d.code)
              .join("path")
              .attr("class", "subregion")
              .attr("d", (d) => path(d.geometry))
              .on("click", function (event, d) {
                event.stopPropagation();
                clearSelections({ keepRegion: true, keepSubregions: true });
                d3.select(this).classed("is-selected", true);
                drawSubregionCountries(d);
                subregionCountriesGroup.classed("is-hidden", false);
                subregionCountriesGroup.raise();
                subregionLabelsGroup.classed("is-hidden", true);
                countryLabelsGroup.classed("is-hidden", false);
                countryLabelsGroup.raise();
                const deepZoomSubregions = new Set(["151", "21", "54"]);
                const isDeepZoom = deepZoomSubregions.has(String(d.code));
                const namedZoomTargets = new Map([
                  ["Melanesia", "Vanuatu"],
                  ["Micronesia", "Micronesia (Federated States of)"],
                  ["Australia and New Zealand", "Australia"],
                  ["Western Europe", "Luxembourg"],
                ]);
                const targetName = namedZoomTargets.get(d.name);
                const targetFeature = targetName
                  ? d.features.find((feature) => feature.properties.name === targetName)
                  : null;
                const useDeeperZoom = d.name === "Micronesia";
                const useShallowerZoom = d.name === "Melanesia";
                const useWesternEuropeZoom = d.name === "Western Europe";
                const useNorthernAmericaZoom = d.name === "Northern America";
                const useEasternEuropeZoom = d.name === "Eastern Europe";
                const useMicronesiaZoom = d.name === "Micronesia";
                const micronesiaClusterNames = new Set([
                  "Micronesia (Federated States of)",
                  "Marshall Islands",
                  "Palau",
                  "Nauru",
                  "Guam",
                  "Northern Mariana Islands",
                ]);
                const micronesiaClusterFeatures = d.features.filter((feature) =>
                  micronesiaClusterNames.has(feature.properties.name)
                );
                const micronesiaFocusFeatures =
                  micronesiaClusterFeatures.length > 0
                    ? micronesiaClusterFeatures
                    : d.features;
                const micronesiaClusterCenter = useMicronesiaZoom
                  ? path.centroid({
                      type: "FeatureCollection",
                      features: micronesiaFocusFeatures,
                    })
                  : null;
                const zoomTarget = useMicronesiaZoom ? d.geometry : targetFeature || d.geometry;
                const micronesiaNudge = [24, -12];
                zoomToGeometry(zoomTarget, {
                  duration: 450,
                  center: useMicronesiaZoom ? micronesiaClusterCenter : null,
                  padding: useWesternEuropeZoom
                    ? 1.25
                    : useNorthernAmericaZoom
                      ? 0.95
                      : useEasternEuropeZoom
                        ? 1.15
                      : useShallowerZoom
                        ? 0.95
                        : useDeeperZoom
                          ? 1.85
                          : isDeepZoom
                            ? 1.2
                            : 1.05,
                  maxScale: useWesternEuropeZoom
                    ? 12
                    : useNorthernAmericaZoom
                      ? 12
                      : useEasternEuropeZoom
                        ? 12
                      : useShallowerZoom
                        ? 8
                        : useDeeperZoom
                          ? 22
                          : isDeepZoom
                          ? 12
                          : 10,
                  xOffset: useMicronesiaZoom
                    ? micronesiaNudge[0]
                    : useEasternEuropeZoom
                      ? -120
                      : 0,
                  yOffset: useMicronesiaZoom
                    ? micronesiaNudge[1]
                    : useNorthernAmericaZoom
                      ? -100
                      : useEasternEuropeZoom
                        ? -150
                        : 0,
                });
                updateSelectionLabel(`${d.name} (sub-region)`);
                updateFactPanel({ name: d.name, kind: "subregion" });
              });

            subregionLabelsGroup
              .classed("is-hidden", false)
              .selectAll("text")
              .data(region.subregions, (d) => d.code)
              .join("text")
              .attr("class", "label subregion-label")
              .attr("x", (d) => {
                const [x, y] = path.centroid(d.geometry);
                if (d.name === "Micronesia") {
                  const estimatedCharWidth = 7.8;
                  return x + d.name.length * estimatedCharWidth * 2;
                }
                return x;
              })
              .attr("y", (d) => {
                const [x, y] = path.centroid(d.geometry);
                if (d.name === "Micronesia") {
                  return y - 10;
                }
                if (d.name === "Western Europe") {
                  return y - 12;
                }
                return y;
              })
              .text((d) => d.name);
          }

          // Draw sub-region countries (hidden until a sub-region is selected).
          function drawSubregionCountries(subregion) {
            subregionCountriesGroup
              .selectAll("path")
              .data(subregion.features)
              .join("path")
              .attr("class", "country")
              .attr("d", path)
              .on("click", function (event, d) {
                event.stopPropagation();
                // Keep the sub-region visible; only highlight the chosen country.
                subregionCountriesGroup.selectAll(".country").classed("is-selected", false);
                d3.select(this).classed("is-selected", true);
                const metadata = subregionByNumeric.get(normalizeNumeric(d.id));
                const subregionName = metadata?.subregion_name || subregion.name;
                updateSelectionLabel(`${d.properties.name || "Unknown"} (${subregionName})`);
              });

            countryLabelsGroup
              .classed("is-hidden", false)
              .selectAll("text")
              .data(subregion.features, (d) => d.id)
              .join("text")
              .attr("class", "label country-label")
              .attr("x", (d) => {
                const [x, y] = path.centroid(d);
                if (d.properties.name === "France") {
                  return x + 20;
                }
                const countryOffsets = new Map([
                  ["Antigua and Barbuda", [6, -4]],
                  ["Barbados", [6, 6]],
                  ["Dominica", [-6, -6]],
                  ["Grenada", [8, 8]],
                  ["Saint Kitts and Nevis", [10, -2]],
                  ["Saint Lucia", [6, 10]],
                  ["Saint Vincent and the Grenadines", [10, 12]],
                  ["Trinidad and Tobago", [12, 10]],
                  ["Haiti", [-6, -4]],
                  ["Dominican Republic", [10, 0]],
                ]);
                if (countryOffsets.has(d.properties.name)) {
                  return x + countryOffsets.get(d.properties.name)[0];
                }
                return x;
              })
              .attr("y", (d) => {
                const [x, y] = path.centroid(d);
                if (d.properties.name === "France") {
                  return y - 24;
                }
                const countryOffsets = new Map([
                  ["Antigua and Barbuda", [6, -4]],
                  ["Barbados", [6, 6]],
                  ["Dominica", [-6, -6]],
                  ["Grenada", [8, 8]],
                  ["Saint Kitts and Nevis", [10, -2]],
                  ["Saint Lucia", [6, 10]],
                  ["Saint Vincent and the Grenadines", [10, 12]],
                  ["Trinidad and Tobago", [12, 10]],
                  ["Haiti", [-6, -4]],
                  ["Dominican Republic", [10, 0]],
                ]);
                if (countryOffsets.has(d.properties.name)) {
                  return y + countryOffsets.get(d.properties.name)[1];
                }
                return y;
              })
              .text((d) => d.properties.name || "");
          }

          // -----------------------------
          // 5) Helper functions
          // -----------------------------
          function clearSelections(options = {}) {
            countriesGroup.selectAll(".country").classed("is-selected", false);
            if (!options.keepRegion) {
              regionGroup.selectAll(".region").classed("is-selected", false);
              subregionGroup.classed("is-hidden", true);
              regionLabelsGroup.classed("is-hidden", false);
              subregionLabelsGroup.classed("is-hidden", true);
              countryLabelsGroup.classed("is-hidden", true);
              resetZoom();
            }
            if (!options.keepSubregions) {
              subregionGroup.selectAll(".subregion").classed("is-selected", false);
              subregionGroup.classed("is-hidden", true);
              subregionLabelsGroup.classed("is-hidden", true);
              countryLabelsGroup.classed("is-hidden", true);
            }
            subregionCountriesGroup.selectAll(".country").classed("is-selected", false);
            subregionCountriesGroup.classed("is-hidden", true);
            countryLabelsGroup.classed("is-hidden", true);
            if (!options.keepRegion && !options.keepSubregions) {
              updateFactPanel(null);
            }
          }

          function updateSelectionLabel(text) {
            d3.select("#selected-country").text(`Selected: ${text}`);
          }

          function updateFactPanel(selection) {
            const factCard = d3.select("#fact-card");
            const factTitle = d3.select("#fact-title");
            const factBody = d3.select("#fact-body");

            if (!selection) {
              factCard.classed("is-hidden", true);
              factTitle.text("");
              factBody.text("");
              return;
            }

            const factLookup =
              selection.kind === "region"
                ? regionFacts.get(selection.name)
                : subregionFacts.get(selection.name);

            if (!factLookup) {
              factCard.classed("is-hidden", true);
              factTitle.text("");
              factBody.text("");
              return;
            }

            const label = `${selection.name} (${factLookup.code})`;
            factTitle.text(label);
            factBody.text(factLookup.fact);
            factCard.classed("is-hidden", false);
          }

          drawCountries();
          drawRegions();
          updateFactPanel(null);
        }
      );
    </script>
  </body>
</html>
